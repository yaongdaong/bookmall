<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <title>도서 상세 정보</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script th:src="@{/js/controller.js}"></script>
</head>
<body>

<div th:replace="~{fragments/common :: header}"/>
<div th:replace="~{fragments/common :: heading}"/>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <a th:href="@{${book.file_path}}">이미지</a>
            <img th:src="@{'/files/' + ${book.id} + '.jpeg'}">
            <img th:src="@{'/files/' + ${book.id} + '.png'}">
            <img th:src="@{'/files/' + ${book.id} + '.jpg'}">
            <!--            <img th:if="${#strings.contains('jpeg,jpg,png', ${book.imageExtension})}" th:src="@{'/files/' + ${book.id} + '.' + ${book.imageExtension}}">-->

            <!--            <img th:each="extension : ${{'jpeg', 'jpg', 'png'}}" th:src="@{'/files/' + ${book.id} + '.' + ${extension}}" />-->
        </div>
        <div class="col-md-8">
            <h3 th:text="${book.title}"></h3>
            <p th:text="${book.description}"></p>
            <br>
            <p><b>도서코드 : </b><span class="badge bg-info text-dark" th:text="${book.id}"/></p>
            <p><b>저자 : </b><span th:text="${book.author}"/></p>
            <p><b>출판사 : </b><span th:text="${book.publisher}"/></p>
            <p><b>출판일 : </b><span th:text="${book.release_date}"/></p>
            <p><b>분류 : </b><span th:text="${book.category}"/></p>
            <p><b>재고수 : </b><span th:text="${book.units_in_stock}"/></p>
            <h4 th:text="${book.unit_price}+'원'"></h4>
            <br>

            <a class="btn btn-primary" th:href="@{'/books/update/' + ${book.id}}">수정</a>

            <br>
            <form th:action="@{'/cart/add/' + ${book.id}}" method="post">
                <input type="hidden" name="bookId" th:value="*{book.id}">
                <input type="number" name="quantity" value="1" min="1">
                <button type="submit">장바구니추가요</button>
            </form>
            <br>

            <form  name="addForm" id="addForm" th:action="@{'/cart/add/' + ${book.id}}" method="put">
                <button class="btn btn-primary" onclick="addToCart('/cart/add/'+${book.id})">장바구니에 추가</button>
                <button class="btn btn-primary" type="submit" onclick="addToCart('/cart/add/${book.id}')">도서 주문
                </button>
                <a class="btn btn-primary" role="button" th:href="@{/cart}"/>장바구니 &raquo;</a>
                <a class="btn btn-secondary" role="button" th:href="@{/books}"/>도서목록 &raquo;</a></p>
            </form>
<!--            <form id="deleteForm" th:action="@{'/books/' + ${book.id}}" method="post">-->
<!--                <input type="hidden" name="_method" value="DELETE"/>-->
<!--                <input type="submit" value="삭제">-->
<!--&lt;!&ndash;                <button id="deleteButton">삭제</button>&ndash;&gt;-->
<!--            </form>-->
            <form id="deleteForm"  th:action="@{'/books/' + ${book.id}}" method="post">
                <input type="hidden" name="_method" value="DELETE" />
                <input class="btn btn-secondary" role="button"  id="deleteButton" type="submit" value="삭제" />
            </form>
        </div>
        </tr>
    </div>
</div>
<hr>
<form id="commentForm">
    <input type="hidden" id="id" value="${book.id}" />
    <textarea id="content" rows="4" cols="50" placeholder="댓글을 입력하세요"></textarea>
    <br />
    <button type="submit">댓글 작성</button>
</form>

<div id="comments">
    <!-- 댓글 목록을 여기에 출력합니다 -->
</div>
<div th:replace="~{fragments/common :: footer}"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
var header = $("meta[name='_csrf_header']").attr('content');
var token = $("meta[name='_csrf']").attr('content');

$(function() {
    $(document).ajaxSend(function(e, xhr, options) {
        xhr.setRequestHeader(header, token);
    });
});

    $(document).ready(function () {
        $("#commentForm").submit(function (event) {
            event.preventDefault();

            var id = $("#id").val();
            var content = $("#content").val();

            var commentData = {
                id: id,
                content: content
            };

            $.ajax({
                type: "POST",
                url: "/api/comments",
                contentType: "application/json",
                data: JSON.stringify(commentData),
                success: function (comment) {
                    // 댓글을 출력하거나 목록을 갱신하는 로직을 작성합니다
                }
            });
        });
    });

    const deleteForm = document.getElementById('deleteForm');
    deleteForm.addEventListener('submit', function (event) {
        event.preventDefault(); // 폼 제출 방지
        fetch(deleteForm.action, {
            method: 'DELETE'
        }).then(response => {
            if (response.status === 200) {
                // 삭제 성공
                // 원하는 동작 수행
                window.location.href = '/books';
            } else {
                // 삭제 실패
                // 에러 처리
            }
        });
    });

<!--const deleteForm = document.getElementById('deleteButton');-->
<!--deleteForm.addEventListener('click', function (event) {-->
<!--event.preventDefault(); // 폼 제출 방지-->

<!--// 사용자에게 삭제 확인을 묻는 팝업 창 표시-->
<!--var confirmDelete = confirm('삭제하시겠습니까?');-->

<!--if (confirmDelete) {-->
<!--fetch(deleteForm.action, {-->
<!--method: 'DELETE'-->
<!--}).then(response => {-->
<!--if (response.status === 200) {-->
<!--// 삭제 성공-->
<!--alert('삭제 성공');-->
<!--window.location.href = '/books'; // 삭제 후 리다이렉트-->
<!--} else {-->
<!--// 삭제 실패-->
<!--alert('삭제 실패');-->
<!--}-->
<!--});-->
<!--} else {-->
<!--// 사용자가 "아니오"를 클릭한 경우 아무 작업도 수행하지 않음-->
<!--alert('삭제 작업이 취소되었습니다');-->
<!--}-->
<!--});-->

<!--    const deleteForm = document.getElementById('deleteButton');-->
<!--    deleteForm.addEventListener('click', function (event) {-->
<!--        event.preventDefault(); // 폼 제출 방지-->

<!--        // 사용자에게 삭제 확인을 묻는 팝업 창 표시-->
<!--        var confirmDelete = confirm('삭제하시겠습니까?');-->

<!--        if (confirmDelete) {-->
<!--            fetch(deleteForm.action, {-->
<!--                method: 'DELETE'-->
<!--            }).then(response => {-->
<!--                if (response.status === 200) {-->
<!--                    // 삭제 성공-->
<!--                    alert('삭제 성공');-->
<!--                    window.location.href = '/books'; // 삭제 후 리다이렉트-->
<!--                } else {-->
<!--                    // 삭제 실패-->
<!--                    alert('삭제 실패');-->
<!--                }-->
<!--            });-->
<!--        } else {-->
<!--            // 사용자가 "아니오"를 클릭한 경우 아무 작업도 수행하지 않음-->
<!--            alert('삭제 작업이 취소되었습니다');-->
<!--        }-->
<!--    });-->
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
</body>
</html>