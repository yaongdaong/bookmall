<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script th:src="@{/js/controller.js}"></script>
</head>
<body>

<div th:replace="~{fragments/common :: header}"/>
<div th:replace="~{fragments/common :: heading}"/>




<div class="container">

    <div style="padding-top:50px">
        <form th:action="@{'/order'}" method="post">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Select</th>
                    <th>도서명</th>
                    <th>가격</th>
                    <th>수량</th>
                    <th>소계</th>
                    <th>삭제</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="cartItem : ${cartItems}">
                    <td>
                        <input type="checkbox" th:name="selectedBooks" th:value="${cartItem.book.title}"/>
                    </td>
                    <td th:text="${cartItem.book.title}"/>
                    <td th:text="${cartItem.book.unit_price}"/>
                    <td>
                        <input type="number" th:value="${cartItem.quantity}" min="1" class="quantity-input"/></td>
                    <td th:text="${cartItem.book.unit_price * cartItem.quantity}"/>

                    <td>
                        <button th:attr="data-book-title=${cartItem.book.title}" th:onclick="deleteCartItem(this)">삭제</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <p>총가격:<span th:text="${total_price}" class="total_price"></span></p>

            <button type="submit">선택 항목 주문</button>
        </form>


        <div>
            <a class="btn btn-primary" role="button" th:href="@{/}"/>주문하기</a>
        </div>
        <!--2.쇼핑 계속하기 버튼을 작성하고 버튼을 누르면 웹 요청 URL은 /books로 이동 -->
        <a th:href="@{/books}" class="btn btn-secondary">&laquo; 쇼핑 계속하기</a>
    </div>
    <form name="clearForm" method="delete">
        <button onclick="clearCart()" class="btn btn-danger">삭제</button>
    </form>
    <a th:href="@{/order(cartId=${cartId})}" class="btn btn-success float-right">주문하기</a>
</div>

<div th:replace="~{fragments/common :: footer}"/>

<script>
    // 수량 변경 이벤트 처리
    document.querySelectorAll('.quantity-input').forEach(function(input){
        input.addEventListener('input', function(){
            updateTotal_price(this);
        });
    });

    // 선택 상태 변경 이벤트 처리
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox){
        checkbox.addEventListener('change',function(){
            updateTotal_price(this);
        });
    });

    // 초기 로드 시 총 합계 계산
    updateTotal_price();

    // 총 합계 업데이트 함수
    function updateTotal_price(triggeredElement) {
        let total = 0;
        document.querySelectorAll('.quantity-input').forEach(function(input, index) {
            const price = parseFloat(document.querySelectorAll('.total_price')[index].textContent);
            const quantity = parseInt(input.value);
            if(!triggeredElement || triggeredElement === input || triggeredElement === document.querySelectorAll('input[type="checkbox"]')[index]) {
                total += quantity * price;
            }
        });
        document.querySelector('.total_price').textContent = total.toFixed(2);
    }

    // 버튼 누르면 선택항목 삭제
    function deleteCartItem(button) {
        const bookTitle = button.getAttribute("data-book-title");
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
</body>
</html>